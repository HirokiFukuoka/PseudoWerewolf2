<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>APLå¯¾BPLï¼šä½“é‡è¨ˆã‚³ã‚¤ãƒ³ã‚²ãƒ¼ãƒ </title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      line-height: 1.4;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    #status {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.1em;
    }
    #coin-container {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      gap: 8px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .coin {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #444;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: #fafafa;
      user-select: none;
      transition: background 0.2s;
    }
    .coin.removed {
      visibility: hidden;
      pointer-events: none;
    }
    .coin.selected {
      background: #d0eaff;
      border-color: #3399ff;
    }
    #controls {
      text-align: center;
      margin-bottom: 20px;
    }
    #controls button {
      margin: 0 5px;
      padding: 8px 12px;
      font-size: 1em;
    }
    #group-choice {
      text-align: center;
      margin: 10px 0;
    }
    #group-choice button {
      margin: 0 10px;
      padding: 6px 10px;
    }
    #result {
      white-space: pre-wrap;
      text-align: center;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      min-height: 3em;
    }
  </style>
</head>
<body>
  <h1>APLå¯¾BPLï¼šä½“é‡è¨ˆã‚³ã‚¤ãƒ³ã‚²ãƒ¼ãƒ </h1>
  <div id="status">ä½“é‡è¨ˆä½¿ç”¨: 0/7 (æ®‹ã‚Š7å›)</div>

  <div id="coin-container"></div>

  <div id="controls">
    <button id="weigh">ä½“é‡è¨ˆã§é‡ã‚‹</button>
    <button id="clear-selection">é¸æŠã‚¯ãƒªã‚¢</button>
    <button id="reset" style="display:none;">æ¬¡ã®ã‚²ãƒ¼ãƒ </button>
  </div>

  <div id="group-choice" style="display:none;">
    <button id="choose-on">ç§¤ã«ä¹—ã›ãŸã‚³ã‚¤ãƒ³ã‹ã‚‰</button>
    <button id="choose-off">ç§¤ã®å¤–ã®ã‚³ã‚¤ãƒ³ã‹ã‚‰</button>
  </div>

  <div id="result"></div>

  <script>
    const REAL_WEIGHT = 10;
    const FAKE_WEIGHT = 9;
    const MAX_WEIGHS = 7;

    let coins = [];         // {id, type:'A'|'B', status:'active'|'removed'}
    let fakesList = [];     // æ­£è§£ã®Bç•ªå·
    let selected = new Set();
    let weighCount = 0;
    let awaitingGroup = false;
    let awaitingPlayerDiscard = false;
    let lastWeighed = [];   // ä»Šå›é‡ã£ãŸã‚³ã‚¤ãƒ³ã®ID

    const statusDiv = document.getElementById('status');
    const coinContainer = document.getElementById('coin-container');
    const resultDiv = document.getElementById('result');
    const weighBtn = document.getElementById('weigh');
    const clearSelBtn = document.getElementById('clear-selection');
    const groupDiv = document.getElementById('group-choice');
    const chooseOnBtn = document.getElementById('choose-on');
    const chooseOffBtn = document.getElementById('choose-off');
    const resetBtn = document.getElementById('reset');

    function init() {
      // ã‚³ã‚¤ãƒ³ç”Ÿæˆãƒ»ã‚·ãƒ£ãƒƒãƒ•ãƒ«å½ç‰©
      coins = [];
      for (let i = 1; i <= 16; i++) {
        coins.push({ id: i, type: 'A', status: 'active' });
      }
      let fakes = new Set();
      while (fakes.size < 4) {
        fakes.add(Math.ceil(Math.random() * 16));
      }
      fakesList = Array.from(fakes).sort((a,b)=>a-b);
      coins.forEach(c => { if (fakes.has(c.id)) c.type = 'B'; });

      // çŠ¶æ…‹åˆæœŸåŒ–
      selected.clear();
      weighCount = 0;
      awaitingGroup = false;
      awaitingPlayerDiscard = false;
      lastWeighed = [];
      updateStatus();
      clearResult();
      hideGroupChoice();
      resetBtn.style.display = 'none';
      weighBtn.disabled = false;
      clearSelBtn.disabled = false;

      renderCoins();
    }

    function updateStatus() {
      const remain = MAX_WEIGHS - weighCount;
      statusDiv.textContent = `ä½“é‡è¨ˆä½¿ç”¨: ${weighCount}/${MAX_WEIGHS} (æ®‹ã‚Š${remain}å›)`;
    }

    function clearResult() {
      resultDiv.textContent = '';
    }

    function addResult(text) {
      resultDiv.textContent += text + '\n';
    }

    function renderCoins() {
      coinContainer.innerHTML = '';
      coins.forEach(c => {
        const btn = document.createElement('div');
        btn.className = 'coin' + (c.status==='removed'? ' removed':'') + (selected.has(c.id)? ' selected':'');
        btn.textContent = (c.status==='removed'? '': c.id);
        btn.onclick = () => onCoinClick(c.id);
        coinContainer.appendChild(btn);
      });
    }

    function onCoinClick(id) {
      const c = coins.find(x=>x.id===id);
      if (!c || c.status !== 'active') return;
      if (awaitingPlayerDiscard) {
        playerDiscard(id);
        return;
      }
      if (awaitingGroup) return;
      // é¸æŠãƒˆã‚°ãƒ«
      if (selected.has(id)) selected.delete(id);
      else selected.add(id);
      renderCoins();
    }

    clearSelBtn.onclick = () => {
      if (awaitingGroup || awaitingPlayerDiscard) return;
      selected.clear();
      renderCoins();
    };

    weighBtn.onclick = () => {
      if (awaitingGroup || awaitingPlayerDiscard) return;
      if (weighCount >= MAX_WEIGHS) {
        addResult('ã‚‚ã†ä½“é‡è¨ˆã¯ä½¿ãˆã¾ã›ã‚“');
        return;
      }
      if (selected.size === 0) {
        addResult('ã¾ãšã‚³ã‚¤ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      // é‡ã‚‹
      weighCount++;
      updateStatus();
      clearResult();
      lastWeighed = Array.from(selected);
      const total = lastWeighed.reduce((sum,id) => {
        const c = coins.find(x=>x.id===id);
        return sum + (c.type==='A'?REAL_WEIGHT:FAKE_WEIGHT);
      }, 0);
      addResult(`ä½“é‡è¨ˆã®é‡ã•: ${total}g`);
      // æ¬¡ã¯ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ
      awaitingGroup = true;
      showGroupChoice();
    };

    function showGroupChoice() {
      groupDiv.style.display = 'block';
      // ç§¤å†…ï¼å¤–ã§AãŒã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒœã‚¿ãƒ³æ´»æ€§åŒ–
      const onA = lastWeighed.filter(id => {
        const c = coins.find(x=>x.id===id);
        return c.status==='active' && c.type==='A';
      }).length;
      const offA = coins.filter(c=>c.status==='active' && !lastWeighed.includes(c.id) && c.type==='A').length;
      chooseOnBtn.disabled = onA===0;
      chooseOffBtn.disabled = offA===0;
    }

    function hideGroupChoice() {
      groupDiv.style.display = 'none';
    }

    chooseOnBtn.onclick = () => groupDiscard(true);
    chooseOffBtn.onclick = () => groupDiscard(false);

    function groupDiscard(fromOnScale) {
      // BPLãŒæœ¬ç‰©ã‚’1å€‹å»ƒæ£„
      const pool = coins.filter(c=> 
        c.status==='active' &&
        c.type==='A' &&
        (fromOnScale ? lastWeighed.includes(c.id) : !lastWeighed.includes(c.id))
      );
      const drop = pool[Math.floor(Math.random()*pool.length)];
      drop.status = 'removed';
      addResult(`BPLãŒ${drop.id}ç•ªã®æœ¬ç‰©ã‚’å»ƒæ£„ã—ã¾ã—ãŸ`);
      awaitingGroup = false;
      hideGroupChoice();
      // æ¬¡ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å»ƒæ£„
      awaitingPlayerDiscard = true;
      addResult('APLã€ä»»æ„ã®ã‚³ã‚¤ãƒ³ã‚’1ã¤å»ƒæ£„ã—ã¦ãã ã•ã„');
      renderCoins();
    }

    function playerDiscard(id) {
      const c = coins.find(x=>x.id===id);
      if (!c || c.status!=='active') return;
      c.status = 'removed';
      addResult(`APLãŒ${c.id}ç•ªã‚’å»ƒæ£„ã—ã¾ã—ãŸ`);
      awaitingPlayerDiscard = false;

      // æœ¬ç‰©æå¤±æ•°ã‚’é€šçŸ¥
      const lostA = c.type==='A' ? 2 : 1;
      addResult(`æœ¬ç‰©ã®æå¤±æ•°: ${lostA}å€‹`);

      renderCoins();
      checkEndOrNext();
    }

    function checkEndOrNext() {
      const alive = coins.filter(c=>c.status==='active');
      const cntB = alive.filter(c=>c.type==='B').length;
      const cntTotal = alive.length;
      // å‹åˆ©åˆ¤å®š
      if (cntB === 0) {
        addResult('ğŸ‰ ã‚ãªãŸã®å‹åˆ©ï¼å½ç‰©ã‚’å…¨ã¦å»ƒæ£„ã—ã¾ã—ãŸ');
        revealFakes();
        finishGame();
      }
      // å¤±æ•—åˆ¤å®š (B >= åŠæ•°)
      else if (cntB*2 >= cntTotal) {
        addResult('ğŸ’¥ å¤±æ•—ï¼å½ç‰©ãŒåŠæ•°ä»¥ä¸Šã«ãªã‚Šã¾ã—ãŸ');
        revealFakes();
        finishGame();
      }
      // æ¬¡ã‚¿ãƒ¼ãƒ³ã¸
      else {
        selected.clear();
        lastWeighed = [];
        renderCoins();
      }
    }

    function revealFakes() {
      addResult(`æ­£è§£ã®å½ç‰©: ${fakesList.join(', ')} ç•ª`);
    }

    function finishGame() {
      weighBtn.disabled = true;
      clearSelBtn.disabled = true;
      hideGroupChoice();
      resetBtn.style.display = 'inline-block';
    }

    resetBtn.onclick = init;

    // åˆæœŸåŒ–
    init();
  </script>
</body>
</html>
